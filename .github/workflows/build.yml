name: ğŸ‘· Build

on:
  push:
    branches: [ main, ci ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: read

jobs:
  build:
    name: ğŸ‘· Build
    # Windows is required for Wix MSI packaging
    runs-on: windows-2025
    env:
      GITVERSIONSPEC: '6.5.1'
    outputs:
      version: ${{ steps.version.outputs.fullSemVer }}
    strategy:
      matrix:
        architecture: [x86, arm64]
    steps:
    - name: ğŸ“¤ Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0 # Deep fetch is required for GitVersion

    - name: ğŸª³ Debug with VSCode if [debug-vscode] is in commit message
      if: >
        contains(github.event.head_commit.message, '[debug-vscode]')
      uses: justingrote/vscode-action@v0.0.2
      with:
        #All these settings are optional
        tunnel-name: 'pingometer'
        connection-timeout: 5
        session-timeout: 60

    - name: ğŸ’§ Cache GitVersion
      id: cache-gitversion
      uses: actions/cache@v5
      with:
        key: ${{ runner.os }}-gitversion-${{ env.GITVERSIONSPEC }}
        path: C:\hostedtoolcache\windows\GitVersion.Tool

    - name: ğŸ“¥ Install GitVersion
      uses: gittools/actions/gitversion/setup@v4.2.0
      with:
        versionSpec: ${{ env.GITVERSIONSPEC }}

    - name: ğŸ§® Determine Version
      id: version
      uses: gittools/actions/gitversion/execute@v4.2.0

    - name: ğŸ’§ .NET Restore Cache
      id: net-restore-cache
      uses: actions/cache@v5
      with:
        key: ${{ runner.os }}-dotnetpackages-${{ hashFiles('**/packages.lock.json') }}
        path: |
          artifacts
          ~/.nuget/packages

    - name: ğŸ“¥ .NET Restore
      if: steps.net-restore-cache.outputs.cache-hit != 'true'
      run: dotnet restore Source/PingoMeter.csproj

    - name: ğŸ“¦ .NET Publish
      run: >
        dotnet publish Source/PingoMeter.csproj
        /p:DebugType=None /p:DebugSymbols=false
        --configuration Release
        --output Release-${{ matrix.architecture }}
        --arch ${{ matrix.architecture }}

    - name: ğŸ¤– Azure CLI Federated Token Login
      if: github.event_name != 'pull_request'
      shell: pwsh
      run: |
        $token = $env:ACTIONS_ID_TOKEN_REQUEST_TOKEN
        $uri = $env:ACTIONS_ID_TOKEN_REQUEST_URL
        $clientId =
        $tenantId =
        $subscriptionId =
        $irmParams = @{
          Uri = $uri
          Authentication = 'Bearer'
          Token = (ConvertTo-SecureString -AsPlainText $token)
          Body = @{audience = 'api://AzureADTokenExchange' }
        }
        $jwtResponse = Invoke-Restmethod @irmParams
        $fedToken = $jwtResponse.value
        if (-not $fedToken) {
          throw "Federated token not found in response: $($jwtResponse | ConvertTo-Json -Depth 10)"
        }

        $azLoginParams = @(
          '--service-principal',
          '-u', '${{ secrets.AZURE_CLIENT_ID }}',
          '-t', '${{ secrets.AZURE_TENANT_ID }}',
          '--federated-token', $fedToken
        )
        & az login @azLoginParams

    - name: ğŸ–Šï¸ Sign PingoMeter executable
      if: github.event_name != 'pull_request'
      uses: azure/artifact-signing-action@v1
      with:
        exclude-azure-cli-credential: false
        exclude-environment-credential: true
        exclude-workload-identity-credential: true
        exclude-managed-identity-credential: true
        exclude-shared-token-cache-credential: true
        exclude-visual-studio-credential: true
        exclude-visual-studio-code-credential: true
        exclude-azure-powershell-credential: true
        exclude-azure-developer-cli-credential: true
        exclude-interactive-browser-credential: true
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
        endpoint: https://wus2.codesigning.azure.net/
        signing-account-name: jgrote
        certificate-profile-name: JustinGrote
        files-folder: ${{ github.workspace }}\Release-${{ matrix.architecture }}
        files-folder-filter: exe

    - name: ğŸ“¦ MSI Installer
      run: >
        dotnet build Installer/PingoMeter.Installer.wixproj
        --configuration Release
        /p:Architecture=${{ matrix.architecture }}
        /p:SourceDir=$pwd\Release-${{ matrix.architecture }}
        /p:Version=${{ steps.version.outputs.fullSemVer }}

    - name: ğŸ–Šï¸ Sign PingoMeter MSI Installer
      if: github.event_name != 'pull_request'
      uses: azure/artifact-signing-action@v1
      with:
        exclude-environment-credential: true
        exclude-workload-identity-credential: true
        exclude-managed-identity-credential: true
        exclude-shared-token-cache-credential: true
        exclude-visual-studio-credential: true
        exclude-visual-studio-code-credential: true
        exclude-azure-cli-credential: false
        exclude-azure-powershell-credential: true
        exclude-azure-developer-cli-credential: true
        exclude-interactive-browser-credential: true
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
        endpoint: https://wus2.codesigning.azure.net/
        signing-account-name: jgrote
        certificate-profile-name: JustinGrote
        files-folder: ${{ github.workspace }}\Installer\bin\Release
        files-folder-filter: "*.msi"

    - name: ğŸ“¤ Upload Release artifact
      uses: actions/upload-artifact@v6
      with:
        name: PingoMeter-${{ matrix.architecture }}
        path: Release-${{ matrix.architecture }}/
        if-no-files-found: error

    - name: ğŸ“¤ Upload MSI Installer
      uses: actions/upload-artifact@v6
      with:
        name: PingoMeter-Installer-${{ matrix.architecture }}
        path: Installer/bin/Release/*.msi
        if-no-files-found: error

    - name: ğŸ“¦ Prepare release assets
      if: github.event_name != 'pull_request'
      run: |
        New-Item -ItemType Directory -Force -Path ReleaseAssets | Out-Null
        $zipName = "PingoMeter-${{ steps.version.outputs.fullSemVer }}-${{ matrix.architecture }}.zip"
        $msiName = "PingoMeter-${{ steps.version.outputs.fullSemVer }}-${{ matrix.architecture }}.msi"
        Compress-Archive -Path "Release-${{ matrix.architecture }}\*" -DestinationPath "ReleaseAssets\$zipName"
        Get-ChildItem -Path "Installer/bin/Release/*.msi" | Copy-Item -Destination "ReleaseAssets\$msiName"

    - name: ğŸ“¤ Upload release assets
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v6
      with:
        name: release-assets-${{ matrix.architecture }}
        path: ReleaseAssets/
        if-no-files-found: error

  draft_release:
    name: ğŸ“ Draft Release
    if: github.ref_type == 'tag'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Download all release assets
        uses: actions/download-artifact@v6
        with:
          path: release-artifacts
          pattern: release-assets-*

      - name: ğŸ“ Generate Draft Release on Tag
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          tag_name: ${{ github.ref_name }}
          files: release-artifacts/release-assets-*/**/*