name: Build PingoMeter

on:
  push:
    branches: [ main, ci ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: read

jobs:
  build:
    # Windows is required for Wix MSI packaging
    runs-on: windows-2025
    outputs:
      version: ${{ steps.version.outputs.fullSemVer }}
    strategy:
      matrix:
        architecture: [x86, arm64]
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0 # Deep fetch is required for GitVersion

    # - name: Debug with VSCode
    #   if: failure() || runner.debug == '1'
    #   uses: justingrote/vscode-action@v0.0.2
    #   with:
    #     #All these settings are optional
    #     tunnel-name: 'pingometer'
    #     connection-timeout: 5
    #     session-timeout: 60

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        cache: true

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v4.2.0
      with:
        versionSpec: '6.5.x'

    - name: Determine Version
      id: version
      uses: gittools/actions/gitversion/execute@v4.2.0

    - name: Restore dependencies
      run: dotnet restore Source/PingoMeter.csproj

    - name: Publish project
      run: dotnet publish Source/PingoMeter.csproj --configuration Release /p:DebugType=None /p:DebugSymbols=false --output Release-${{ matrix.architecture }} --arch ${{ matrix.architecture }}

    - name: Azure Login
      if: github.event_name != 'pull_request'
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: true

    - name: Sign PingoMeter executable
      if: github.event_name != 'pull_request'
      uses: azure/artifact-signing-action@v1
      with:
        exclude-environment-credential: true
        exclude-workload-identity-credential: true
        exclude-managed-identity-credential: true
        exclude-shared-token-cache-credential: true
        exclude-visual-studio-credential: true
        exclude-visual-studio-code-credential: true
        exclude-azure-cli-credential: false
        exclude-azure-powershell-credential: true
        exclude-azure-developer-cli-credential: true
        exclude-interactive-browser-credential: true
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
        endpoint: https://wus2.codesigning.azure.net/
        signing-account-name: jgrote
        certificate-profile-name: JustinGrote
        files-folder: ${{ github.workspace }}\Release-${{ matrix.architecture }}
        files-folder-filter: exe

    - name: Build MSI Installer
      run: dotnet build Installer/PingoMeter.Installer.wixproj --configuration Release /p:Architecture=${{ matrix.architecture }} /p:SourceDir=$pwd\Release-${{ matrix.architecture }} /p:Version=${{ steps.version.outputs.fullSemVer }}

    - name: Sign PingoMeter MSI Installer
      if: github.event_name != 'pull_request'
      uses: azure/artifact-signing-action@v1
      with:
        exclude-environment-credential: true
        exclude-workload-identity-credential: true
        exclude-managed-identity-credential: true
        exclude-shared-token-cache-credential: true
        exclude-visual-studio-credential: true
        exclude-visual-studio-code-credential: true
        exclude-azure-cli-credential: false
        exclude-azure-powershell-credential: true
        exclude-azure-developer-cli-credential: true
        exclude-interactive-browser-credential: true
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
        endpoint: https://wus2.codesigning.azure.net/
        signing-account-name: jgrote
        certificate-profile-name: JustinGrote
        files-folder: ${{ github.workspace }}\Installer\bin\Release
        files-folder-filter: "*.msi"

    - name: Upload Release artifact
      uses: actions/upload-artifact@v6
      with:
        name: PingoMeter-${{ matrix.architecture }}
        path: Release-${{ matrix.architecture }}/
        if-no-files-found: error

    - name: Upload MSI Installer
      uses: actions/upload-artifact@v6
      with:
        name: PingoMeter-Installer-${{ matrix.architecture }}
        path: Installer/bin/Release/*.msi
        if-no-files-found: error

    - name: Prepare release assets
      if: github.event_name != 'pull_request'
      run: |
        New-Item -ItemType Directory -Force -Path ReleaseAssets | Out-Null
        $zipName = "PingoMeter-${{ steps.version.outputs.fullSemVer }}-${{ matrix.architecture }}.zip"
        $msiName = "PingoMeter-${{ steps.version.outputs.fullSemVer }}-${{ matrix.architecture }}.msi"
        Compress-Archive -Path "Release-${{ matrix.architecture }}\*" -DestinationPath "ReleaseAssets\$zipName"
        Get-ChildItem -Path "Installer/bin/Release/*.msi" | Copy-Item -Destination "ReleaseAssets\$msiName"

    - name: Upload release assets
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v6
      with:
        name: release-assets-${{ matrix.architecture }}
        path: ReleaseAssets/
        if-no-files-found: error

  draft_release:
    if: github.ref_type == 'tag'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all release assets
        uses: actions/download-artifact@v6
        with:
          path: release-artifacts
          pattern: release-assets-*

      - name: Generate Draft Release on Tag
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          tag_name: ${{ github.ref_name }}
          files: release-artifacts/release-assets-*/**/*