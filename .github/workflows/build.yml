name: Build PingoMeter

on:
  push:
    branches: [ main, ci ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: read

jobs:
  build:
    # Windows is required for Wix MSI packaging
    runs-on: windows-2025

    strategy:
      matrix:
        architecture: [x86, arm64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '10.0.x'
        cache: true

    - name: Restore dependencies
      run: dotnet restore Source/PingoMeter.csproj

    - name: Set Version
      id: set_version
      run: |
        if ( '${{ github.ref_name }}' -like 'v*' ) {
          $version = "${{ github.ref_name }}".Substring(1)
        } else {
          $version = "0.0.0-ci.${{ github.run_id }}+${{ github.sha }}"
        }
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append
        "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    - name: Publish project
      run: dotnet publish Source/PingoMeter.csproj --configuration Release /p:DebugType=None /p:DebugSymbols=false --output Release-${{ matrix.architecture }} --arch ${{ matrix.architecture }} /p:Version=$env:VERSION

    - name: Azure login
      if: startsWith(github.ref, 'refs/tags/v')
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        enable-AzPSSession: true

    - name: Sign PingoMeter executable
      if: startsWith(github.ref, 'refs/tags/v')
      uses: azure/artifact-signing-action@v1
      with:
        exclude-environment-credential: true
        exclude-workload-identity-credential: true
        exclude-managed-identity-credential: true
        exclude-shared-token-cache-credential: true
        exclude-visual-studio-credential: true
        exclude-visual-studio-code-credential: true
        exclude-azure-cli-credential: false
        exclude-azure-powershell-credential: true
        exclude-azure-developer-cli-credential: true
        exclude-interactive-browser-credential: true
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
        endpoint: https://wus2.codesigning.azure.net/
        signing-account-name: jgrote
        certificate-profile-name: JustinGrote
        files-folder: ${{ github.workspace }}\Release-${{ matrix.architecture }}
        files-folder-filter: exe

    - name: Build MSI Installer
      run: dotnet build Installer/PingoMeter.Installer.wixproj --configuration Release /p:Architecture=${{ matrix.architecture }} /p:SourceDir=$pwd\Release-${{ matrix.architecture }} /p:Version=$env:VERSION

    - name: Sign PingoMeter MSI Installer
      if: startsWith(github.ref, 'refs/tags/v')
      uses: azure/artifact-signing-action@v1
      with:
        exclude-environment-credential: true
        exclude-workload-identity-credential: true
        exclude-managed-identity-credential: true
        exclude-shared-token-cache-credential: true
        exclude-visual-studio-credential: true
        exclude-visual-studio-code-credential: true
        exclude-azure-cli-credential: false
        exclude-azure-powershell-credential: true
        exclude-azure-developer-cli-credential: true
        exclude-interactive-browser-credential: true
        file-digest: SHA256
        timestamp-rfc3161: http://timestamp.acs.microsoft.com
        timestamp-digest: SHA256
        endpoint: https://wus2.codesigning.azure.net/
        signing-account-name: jgrote
        certificate-profile-name: JustinGrote
        files-folder: ${{ github.workspace }}\Installer\bin\Release
        files-folder-filter: "*.msi"

    - name: Upload Release artifact
      uses: actions/upload-artifact@v6
      with:
        name: PingoMeter-${{ matrix.architecture }}
        path: Release-${{ matrix.architecture }}/
        if-no-files-found: error

    - name: Upload MSI Installer
      uses: actions/upload-artifact@v6
      with:
        name: PingoMeter-Installer-${{ matrix.architecture }}
        path: Installer/bin/Release/*.msi
        if-no-files-found: error

    - name: Draft Release Notes for main branch pushes
      if: startsWith(github.ref, 'refs/tags/v')

      uses: release-drafter/release-drafter@v6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        config-name: release-drafter.yml

    - name: Prepare release assets
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        New-Item -ItemType Directory -Force -Path ReleaseAssets | Out-Null
        $zipName = "PingoMeter-$env:VERSION-${{ matrix.architecture }}.zip"
        $msiName = "PingoMeter-$env:VERSION-${{ matrix.architecture }}.msi"
        Compress-Archive -Path "Release-${{ matrix.architecture }}\*" -DestinationPath "ReleaseAssets\$zipName"
        Get-ChildItem -Path "Installer/bin/Release/*.msi" | Copy-Item -Destination "ReleaseAssets\$msiName"

    - name: Upload assets to release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/v')
      with:
        files: ReleaseAssets/*
        tag_name: ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}